<!DOCTYPE html>
<html>
<head>
<title>Console</title>
</head>
<body>
<p>
  <button id="connect">Connect to device</button>
</p>
<p>
  <button id="on">LED ON</button>
  <button id="off">LED OFF</button>
</p>

<script src="serial.js"></script>
<script>
var port
let textEncoder = new TextEncoder()

document.querySelector('#on').addEventListener('click', function(event) {
  if (port !== undefined) {
    port.send(textEncoder.encode('H')).catch(error => {
      console.log('Send error: ' + error)
    })

    console.log('Sending H')
  }
})

document.querySelector('#off').addEventListener('click', function(event) {
  if (port !== undefined) {
    port.send(textEncoder.encode('L')).catch(error => {
      console.log('Send error: ' + error)
    })

    console.log('Sending L')
  }
})

document.addEventListener('DOMContentLoaded', event => {
  let connectButton = document.querySelector('#connect')

  function connect() {
    console.log('Connecting to ' + port.device_.productName + '...')
    port.connect().then(() => {
      console.log(port)
      console.log('Connected.')
      connectButton.textContent = 'Disconnect'
      port.onReceive = data => {
        let textDecoder = new TextDecoder()
        console.log(textDecoder.decode(data))
      }
      port.onReceiveError = error => {
        console.log('Receive error: ' + error)
      }
    }, error => {
      console.log('Connection error: ' + error)
    })
  }

  connectButton.addEventListener('click', function() {
    if (port) {
      port.disconnect()
      connectButton.textContent = 'Connect'
      port = null
    } else {
      serial.requestPort().then(selectedPort => {
        port = selectedPort
        connect()
      }).catch(error => {
        console.log('Connection error: ' + error)
      })
    }
  })

  serial.getPorts().then(ports => {
    if (ports.length == 0) {
      console.log('No devices found.')
    } else {
      port = ports[0]
      connect()
    }
  })
})
</script>
</body>
</html>
